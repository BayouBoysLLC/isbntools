#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
from isbntools import canonical, clean, config, get_canonical_isbn, \
    get_isbnlike, meta, registry
from isbntools.dev._files import File
from isbntools.dev._fmt import fmts
from isbntools.dev.rename import checkpattern, newfilename


def usage(wservs="wcat|goob|..."):
    sys.stderr.write('Usage: \n\nisbn_rename [ISBN|\'-f\'] [%s] '
                     '[\'key=\'apikey] [pattern] filename\n  '
                     '...  or try with '
                     'another service in list!\n' % (wservs))
    sys.stderr.write(
        '\n  - If the \'-f\' flag is used instead of an ISBN, \n'
        '    the file name will be searched for a valid ISBN.\n'
        '  - [pattern] must be a string in quotes containing\n  '
        '    only ASCII letters, digits and \'#\'-_.,() \'\n  '
        '    and one or more of the following placeholders:\n  '
        '    - {authorsFullNames}    (full names of the author(s))\n  '
        '    - {authorsLastNames}    (last names of the author(s))\n  '
        '    - {firstAuthorLastName} (only last name of first author)\n'
        '    - {year}\n  '
        '    - {publisher}\n  '
        '    - {title}\n  '
        '    - {isbn}(ISBN-13) \n  '
        '    - {language}\n  '
        '    Author names are separated with commas, (\',\').\n  '
        '    Default pattern is \"'
        '{authorslast}_{year}_{title}_{isbn}\".\n\n')
    sys.exit(1)


def parse_args(args):
    """
    parse and return a tuple of the command line arguments
    """

    if len(args) == 2:
        return (args[0], None, None, None, args[1])

    if len(args) == 5:
        return (args[0], args[1], args[2][4:], args[3], args[4])

    service = None
    for s in registry.services.keys():
        if args[1] == s:
            service = args[1]

    if not service:  # second arg is pattern
        return (args[0], None, None, args[1], args[-1])

    if len(args) == 3:
        return (args[0], args[1], None, None, args[-1])

    if args[2].startswith('key='):
        return (args[0], args[1], args[2][4:], None, args[-1])
    else:
        return (args[0], args[1], None, args[2], args[-1])


def main(args):

    try:
        isbnorflag, service, apikey, pattern, filename = parse_args(args)

        if pattern and not checkpattern(pattern):
            return None

        oldfile = File(filename)
        name = oldfile.name
        if isbnorflag != '-f':
            isbn = get_canonical_isbn(canonical(clean(args[0])))
        else:
            isbn = canonical(get_isbnlike(name, level='normal')[0])
            if not isbn:
                sys.stderr.write(
                    'no ISBN found in file name \'' + name + '\'' + '\n')
                return None
            sys.stderr.write('found ISBN in file name: '
                             + isbn + '\n')

        if apikey:
            try:
                config.add_apikey(service, apikey)
            except:
                pass

        if service:
            metadata = meta(isbn, service)
        else:
            metadata = meta(isbn)

        ext = oldfile.ext
        if pattern:
            newbasename = newfilename(metadata, pattern) + ext
        else:
            newbasename = newfilename(metadata) + ext

        oldbasename = oldfile.basename
        success = oldfile.baserename(newbasename)
        if success:
            sys.stdout.write('renamed \''
                             + oldbasename + '\' to \''
                             + oldfile.basename + '\'\n')
        return oldfile.basename

    except Exception as e:
        sys.stderr.write(str(e) + '\n')
        sys.stderr.write('\n')
        providers = list(registry.services.keys())
        providers.remove('default')
        available = '|'.join(providers)
        try:
            fmts.remove('labels')
        except ValueError as e:
            sys.stderr.write('Already removed \'labels\' from fmts: '
                             + str(e))
        usage(available)
        return None


if __name__ == "__main__":
    main(sys.argv[1:])
